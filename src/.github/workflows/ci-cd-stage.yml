name: CI/CD - Stage

on:
  push:
    branches:
      - main  # Ou troque para a branch que quiser usar no stage

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ³ Autenticar no Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS_STAGE }}'

      - name: ğŸ“¦ Configurar Docker para GCR
        run: gcloud auth configure-docker

      - name: ğŸ—ï¸ Build da imagem Docker
        run: docker build -t gcr.io/drivex-stage/drivex-api:latest .

      - name: ğŸš€ Push para o GCR
        run: docker push gcr.io/drivex-stage/drivex-api:latest

      - name: â˜¸ï¸ Configurar kubectl
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: cluster-stage-drivex
          location: us-east1
          project_id: drivex-stage

      - name: ğŸš¢ Deploy para o cluster
        run: kubectl apply -f src/k8s/
